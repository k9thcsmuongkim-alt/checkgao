<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Camera Ultimate Debug</title>
    <style>
        body { background-color: #000; color: #0f0; font-family: 'Consolas', monospace; display: flex; flex-direction: column; align-items: center; margin: 0; padding: 10px; }
        h2 { color: #fff; margin: 5px 0; font-size: 1.2rem; }
        
        /* Khu v·ª±c ƒëi·ªÅu khi·ªÉn */
        #controls { width: 100%; max-width: 600px; text-align: center; margin-bottom: 10px; }
        button { padding: 12px 20px; font-size: 16px; font-weight: bold; cursor: pointer; border: none; border-radius: 4px; margin: 5px; }
        .btn-check { background: #ff9800; color: #000; }
        .btn-start { background: #2196F3; color: #fff; display: none; } /* ·∫®n n√∫t start l√∫c ƒë·∫ßu */
        
        /* M√†n h√¨nh hi·ªÉn th·ªã */
        #canvas-container { position: relative; width: 100%; max-width: 480px; border: 2px solid #333; background: #111; min-height: 300px; display: flex; justify-content: center; align-items: center; }
        canvas { width: 100%; height: auto; display: block; }
        video { display: none; }
        
        /* Nh·∫≠t k√Ω l·ªói (Quan tr·ªçng nh·∫•t) */
        #console-log { 
            width: 100%; max-width: 600px; height: 200px; 
            background: #0d0d0d; border: 1px solid #444; 
            overflow-y: scroll; font-size: 12px; 
            padding: 10px; margin-top: 10px; text-align: left; 
            white-space: pre-wrap; word-wrap: break-word;
        }
        
        /* M√†u s·∫Øc tr·∫°ng th√°i */
        .log-info { color: #0f0; }
        .log-warn { color: #ffeb3b; }
        .log-error { color: #ff5555; font-weight: bold; border-left: 3px solid #ff5555; padding-left: 5px; }
        .status-text { font-size: 18px; font-weight: bold; margin: 10px 0; color: #fff; }
    </style>
</head>
<body>

    <h2>AI CAMERA DEBUGGER</h2>
    
    <div id="controls">
        <div id="status" class="status-text">B1: B·∫•m n√∫t Ki·ªÉm tra file</div>
        <button class="btn-check" onclick="runDiagnostics()">1. KI·ªÇM TRA FILE & H·ªÜ TH·ªêNG</button>
        <button class="btn-start" onclick="startCamera()">2. B·∫¨T CAMERA</button>
    </div>

    <div id="canvas-container">
        <canvas id="output"></canvas>
        <span id="placeholder-text" style="color: #555;">Camera s·∫Ω hi·ªán ·ªü ƒë√¢y...</span>
    </div>
    
    <video id="webcam" playsinline autoplay muted></video>

    <div id="console-log">Nh·∫≠t k√Ω h·ªá th·ªëng s·∫Ω hi·ªán ·ªü ƒë√¢y...</div>

    <script>
        // T√™n file ch√≠nh x√°c (C·∫ßn s·ª≠a n·∫øu file b·∫°n t√™n kh√°c)
        const CONFIG = {
            js: "edge-impulse-standalone.js",
            wasm: "edge-impulse-standalone.wasm", // QUAN TR·ªåNG: Ph·∫£i ƒë√∫ng t·ª´ng k√Ω t·ª±
            helper: "run-impulse.js"
        };

        const logArea = document.getElementById('console-log');
        const statusEl = document.getElementById('status');
        const btnCheck = document.querySelector('.btn-check');
        const btnStart = document.querySelector('.btn-start');

        // H√†m ghi nh·∫≠t k√Ω ra m√†n h√¨nh
        function log(msg, type = 'info') {
            const time = new Date().toLocaleTimeString();
            logArea.innerHTML += `<div class="log-${type}">[${time}] ${msg}</div>`;
            logArea.scrollTop = logArea.scrollHeight;
        }

        // ƒê·ªãnh nghƒ©a Module ƒë·ªÉ h·ª©ng file JS
        var Module = {
            onRuntimeInitialized: function() {
                log("‚úÖ WASM Runtime ƒë√£ kh·ªüi ch·∫°y th√†nh c√¥ng!", 'info');
                window.isWasmReady = true;
                statusEl.innerText = "S·∫µn s√†ng! H√£y b·∫•m n√∫t B·∫≠t Camera";
                statusEl.style.color = "#00ff00";
                btnStart.style.display = 'inline-block';
                btnCheck.style.display = 'none';
            },
            locateFile: function(path, scriptDirectory) {
                log(`‚ö†Ô∏è H·ªá th·ªëng ƒëang t√¨m file: '${path}'`, 'warn');
                log(`üëâ ƒêang √©p ƒë∆∞·ªùng d·∫´n v·ªÅ: '${CONFIG.wasm}'`, 'info');
                return CONFIG.wasm; // Lu√¥n tr·∫£ v·ªÅ ƒë√∫ng t√™n file wasm c·ªßa m√¨nh
            }
        };
    </script>

    <script>
        async function runDiagnostics() {
            log("--- B·∫ÆT ƒê·∫¶U KI·ªÇM TRA H·ªÜ TH·ªêNG ---", 'info');
            btnCheck.disabled = true;
            let errors = 0;

            // 1. Ki·ªÉm tra File JS
            try {
                log(`ƒêang ki·ªÉm tra file JS: ${CONFIG.js}...`);
                const res = await fetch(CONFIG.js);
                if (res.ok) log(`‚úÖ ƒê√£ t√¨m th·∫•y JS (${res.status} OK)`, 'info');
                else throw new Error(`Kh√¥ng t√¨m th·∫•y file JS (L·ªói ${res.status})`);
            } catch (e) {
                log(`‚ùå L·ªñI NGHI√äM TR·ªåNG: ${e.message}`, 'error');
                log("üëâ B·∫°n ch∆∞a upload file .js ho·∫∑c sai t√™n file.", 'error');
                errors++;
            }

            // 2. Ki·ªÉm tra File WASM (Nguy√™n nh√¢n ch√≠nh g√¢y l·ªói 404/Treo)
            try {
                log(`ƒêang ki·ªÉm tra file WASM: ${CONFIG.wasm}...`);
                const res = await fetch(CONFIG.wasm);
                if (res.ok) log(`‚úÖ ƒê√£ t√¨m th·∫•y WASM (${res.status} OK)`, 'info');
                else throw new Error(`Kh√¥ng t√¨m th·∫•y file WASM (L·ªói ${res.status})`);
            } catch (e) {
                log(`‚ùå L·ªñI NGHI√äM TR·ªåNG: ${e.message}`, 'error');
                log("üëâ B·∫°n ch∆∞a upload file .wasm ho·∫∑c t√™n file tr√™n GitHub kh√°c t√™n trong code.", 'error');
                errors++;
            }

            if (errors > 0) {
                statusEl.innerText = "‚ùå THI·∫æU FILE! XEM NH·∫¨T K√ù B√äN D∆Ø·ªöI";
                statusEl.style.color = "red";
                btnCheck.disabled = false;
                alert("B·∫°n b·ªã thi·∫øu file quan tr·ªçng. H√£y ƒë·ªçc d√≤ng ch·ªØ m√†u ƒë·ªè trong khung nh·∫≠t k√Ω!");
                return;
            }

            // N·∫øu file ƒë·ªß, b·∫Øt ƒë·∫ßu n·∫°p script
            log("‚úÖ File ƒë·∫ßy ƒë·ªß. ƒêang n·∫°p th∆∞ vi·ªán...", 'info');
            loadScripts();
        }

        function loadScripts() {
            // N·∫°p file JS ch√≠nh
            const script = document.createElement('script');
            script.src = CONFIG.js;
            script.onload = () => log("ƒê√£ n·∫°p file JS ch√≠nh.", 'info');
            script.onerror = () => log("‚ùå Kh√¥ng th·ªÉ ch·∫°y file JS ch√≠nh. File c√≥ th·ªÉ b·ªã h·ªèng.", 'error');
            document.body.appendChild(script);

            // N·∫°p file ph·ª• tr·ª£
            const script2 = document.createElement('script');
            script2.src = CONFIG.helper;
            script2.onload = () => log("ƒê√£ n·∫°p file run-impulse.js", 'info');
            document.body.appendChild(script2);
        }
    </script>

    <script>
        const video = document.getElementById('webcam');
        const canvas = document.getElementById('output');
        const ctx = canvas.getContext('2d');
        var classifier = null;

        async function startCamera() {
            if (!window.isWasmReady) {
                alert("AI ch∆∞a t·∫£i xong. Vui l√≤ng ƒë·ª£i d√≤ng ch·ªØ 'WASM Runtime' hi·ªán l√™n.");
                return;
            }

            btnStart.disabled = true;
            statusEl.innerText = "ƒêang kh·ªüi ƒë·ªông Camera...";

            try {
                // Kh·ªüi t·∫°o Classifier
                if (typeof EdgeImpulseClassifier === 'undefined') {
                    throw new Error("Kh√¥ng t√¨m th·∫•y EdgeImpulseClassifier. File run-impulse.js c√≥ v·∫•n ƒë·ªÅ?");
                }

                log("ƒêang kh·ªüi t·∫°o b·ªô n√£o AI...", 'info');
                classifier = new EdgeImpulseClassifier();
                await classifier.init();
                log("‚úÖ Classifier Init th√†nh c√¥ng!", 'info');

                // L·∫•y th√¥ng tin Project
                try {
                    const project = classifier.getProjectInfo();
                    log(`D·ª± √°n: ${project.owner} / ${project.name}`, 'info');
                } catch(e) { log("Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c th√¥ng tin d·ª± √°n (Kh√¥ng sao).", 'warn'); }

                // M·ªü Camera
                log("ƒêang xin quy·ªÅn Camera...", 'info');
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: false,
                    video: { facingMode: "environment", width: { ideal: 640 }, height: { ideal: 480 } }
                });

                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    video.play();
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    document.getElementById('placeholder-text').style.display = 'none';
                    statusEl.innerText = "ƒêang nh·∫≠n di·ªán...";
                    log("üé• Camera ƒë√£ b·∫≠t! ƒêang ch·∫°y v√≤ng l·∫∑p...", 'info');
                    requestAnimationFrame(loop);
                };

            } catch (err) {
                log(`‚ùå L·ªñI CAMERA/AI: ${err.message}`, 'error');
                statusEl.innerText = "L·ªói! Xem nh·∫≠t k√Ω.";
                alert("G·∫∑p l·ªói: " + err.message);
                btnStart.disabled = false;
            }
        }

        async function loop() {
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            if (classifier) {
                try {
                    let res = classifier.classifyElements(video);
                    
                    if (res && res.results && res.results.length > 0) {
                        res.results.forEach(obj => {
                            // V·∫Ω khung (Object Detection / FOMO)
                            if (obj.x !== undefined) {
                                ctx.strokeStyle = '#00FF00'; ctx.lineWidth = 4;
                                ctx.strokeRect(obj.x, obj.y, obj.width, obj.height);
                                ctx.fillStyle = '#00FF00'; ctx.font = '20px Arial';
                                ctx.fillText(`${obj.label} ${(obj.value*100).toFixed(0)}%`, obj.x, obj.y - 5);
                            } 
                            // Ph√¢n lo·∫°i (Classification)
                            else if (obj.value > 0.5) {
                                ctx.fillStyle = "yellow"; ctx.font = "30px Arial";
                                ctx.fillText(`${obj.label}: ${(obj.value*100).toFixed(0)}%`, 20, 50);
                            }
                        });
                    }
                } catch (e) {
                    // L·ªói trong v√≤ng l·∫∑p th∆∞·ªùng do video ch∆∞a s·∫µn s√†ng, b·ªè qua
                }
            }
            requestAnimationFrame(loop);
        }
    </script>
</body>
</html>
