<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Camera Deep Log</title>
    <style>
        body { background: #000; color: #fff; font-family: monospace; display: flex; flex-direction: column; align-items: center; margin: 0; padding: 10px; }
        #controls { width: 100%; text-align: center; border-bottom: 1px solid #333; padding-bottom: 10px; }
        
        #log-area { 
            width: 100%; height: 350px; background: #111; border: 1px solid #555; 
            overflow-y: scroll; font-size: 11px; padding: 5px; text-align: left; 
            white-space: pre-wrap; color: #ccc; font-family: 'Consolas', monospace;
        }
        
        canvas { width: 100%; max-width: 480px; border: 2px solid #333; margin-top: 10px; }
        video { display: none; }
        
        .log-std { color: #ddd; }
        .log-err { color: #ff5555; font-weight: bold; border-left: 3px solid red; padding-left: 5px; }
        .log-sys { color: #00ff00; font-weight: bold; }
        .log-warn { color: yellow; }
    </style>
</head>
<body>

    <div id="controls">
        <h2 style="margin:5px;">DEEP DEBUG MODE</h2>
        <div id="status">ƒêang kh·ªüi t·∫°o m√¥i tr∆∞·ªùng...</div>
    </div>

    <div id="log-area">...</div>
    <canvas id="output"></canvas>
    <video id="webcam" playsinline autoplay muted></video>

    <script>
        const logArea = document.getElementById('log-area');
        const statusEl = document.getElementById('status');
        
        function log(msg, type='std') {
            logArea.innerHTML += `<div class="log-${type}">[${new Date().toLocaleTimeString()}] ${msg}</div>`;
            logArea.scrollTop = logArea.scrollHeight;
        }

        // B·∫Øt l·ªói to√†n c·ª•c c·ªßa tr√¨nh duy·ªát
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            log(`CRITICAL JS ERROR: ${msg} (Line ${lineNo})`, 'err');
            return false;
        };

        // B·∫Øt l·ªói Promise (th∆∞·ªùng l√† l·ªói t·∫£i WASM)
        window.onunhandledrejection = function(event) {
            log(`UNHANDLED PROMISE: ${event.reason}`, 'err');
        };

        // --- C·∫§U H√åNH MODULE EMSCRIPTEN ---
        var Module = {
            // 1. Nghe l√©n th√¥ng tin b√¨nh th∆∞·ªùng t·ª´ C++
            print: function(text) {
                log(`[STDOUT] ${text}`, 'std');
            },
            // 2. Nghe l√©n L·ªñI t·ª´ C++ (ƒê√¢y l√† c√°i ch√∫ng ta c·∫ßn t√¨m!)
            printErr: function(text) {
                log(`[STDERR] ${text}`, 'err');
                if (text.includes("memory")) {
                    alert("L·ªói b·ªô nh·ªõ! ƒêi·ªán tho·∫°i kh√¥ng ƒë·ªß RAM.");
                }
            },
            // 3. Theo d√µi tr·∫°ng th√°i t·∫£i file
            setStatus: function(text) {
                log(`[STATUS] ${text}`, 'sys');
                statusEl.innerText = text;
            },
            // 4. Theo d√µi file c√≤n thi·∫øu
            monitorRunDependencies: function(left) {
                log(`[MONITOR] C√≤n ${left} file c·∫ßn t·∫£i...`, 'warn');
            },
            // 5. Khi ch·∫°y xong
            onRuntimeInitialized: function() {
                log("‚úÖ K·∫æT TH√öC: Runtime ƒë√£ n·∫°p xong!", 'sys');
                window.isModelReady = true;
            },
            // 6. Ch·ªâ ƒë∆∞·ªùng d·∫´n
            locateFile: function(path) {
                log(`[LOCATE] ƒêang t√¨m: ${path}`, 'warn');
                return "edge-impulse-standalone.wasm";
            }
        };
    </script>

    <script src="edge-impulse-standalone.js"></script>
    <script src="run-impulse.js"></script>

    <script>
        const video = document.getElementById('webcam');
        const canvas = document.getElementById('output');
        const ctx = canvas.getContext('2d');
        var classifier = null;

        // Thay v√¨ ch·ªù onRuntimeInitialized (v√¨ n√≥ ƒëang l·ªói), ta d√πng v√≤ng l·∫∑p ki·ªÉm tra
        let checkInterval = setInterval(() => {
            if (typeof EdgeImpulseClassifier !== 'undefined') {
                log("üîç ƒê√£ th·∫•y class EdgeImpulseClassifier. ƒêang th·ª≠ kh·ªüi t·∫°o...", 'sys');
                clearInterval(checkInterval);
                startApp();
            }
        }, 1000);

        async function startApp() {
            try {
                classifier = new EdgeImpulseClassifier();
                await classifier.init();
                log("‚úÖ Classifier Init th√†nh c√¥ng! (B·ªè qua l·ªói WASM)", 'sys');
                
                // M·ªü Camera
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: false,
                    video: { facingMode: "environment", width: 640, height: 480 }
                });
                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    video.play();
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    requestAnimationFrame(loop);
                };
            } catch (e) {
                log(`‚ùå KH·ªûI ƒê·ªòNG TH·∫§T B·∫†I: ${e.message}`, 'err');
                log("üëâ G·ª£i √Ω: N·∫øu l·ªói l√† 'Failed to fetch', h√£y ki·ªÉm tra l·∫°i t√™n file .wasm tr√™n GitHub.", 'err');
            }
        }

        async function loop() {
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            if (classifier) {
                try {
                    let res = classifier.classifyElements(video);
                    if (res && res.results.length > 0) {
                        // V·∫Ω k·∫øt qu·∫£ ƒë·ªÉ bi·∫øt n√≥ ch·∫°y
                         res.results.forEach(obj => {
                            if (obj.x !== undefined) {
                                ctx.strokeStyle = '#00FF00'; ctx.lineWidth = 4;
                                ctx.strokeRect(obj.x, obj.y, obj.width, obj.height);
                            }
                        });
                    }
                } catch (e) {}
            }
            requestAnimationFrame(loop);
        }
    </script>
</body>
</html>
