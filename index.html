<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Camera Kickstarter</title>
    <style>
        body { background: #000; color: #0f0; font-family: monospace; display: flex; flex-direction: column; align-items: center; margin: 0; padding: 10px; }
        #controls { width: 100%; text-align: center; margin-bottom: 10px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        button { padding: 15px 30px; font-size: 16px; font-weight: bold; cursor: pointer; border: none; border-radius: 5px; margin: 5px; }
        .btn-check { background: #ff9800; color: #000; }
        .btn-force { background: #E91E63; color: #fff; display: none; } /* N√∫t k√≠ch n·ªï th·ªß c√¥ng */
        
        #log-area { 
            width: 100%; height: 250px; background: #111; border: 1px solid #555; 
            overflow-y: scroll; font-size: 12px; padding: 10px; text-align: left; 
            white-space: pre-wrap; color: #ddd;
        }
        
        canvas { width: 100%; max-width: 480px; border: 2px solid #333; margin-top: 10px; }
        video { display: none; }
        .log-err { color: #ff5555; font-weight: bold; }
        .log-success { color: #00ff00; }
        .log-warn { color: yellow; }
    </style>
</head>
<body>

    <div id="controls">
        <h2 style="color:white; margin:0 0 10px 0;">AI CAMERA KICKSTARTER</h2>
        <div id="status" style="color:white; margin-bottom:10px;">Tr·∫°ng th√°i: Ch·ªù l·ªánh...</div>
        <button class="btn-check" onclick="runSystem()">1. CH·∫†Y H·ªÜ TH·ªêNG</button>
        <button class="btn-force" onclick="forceStart()">‚ö° K√çCH N·ªî TH·ª¶ C√îNG</button>
    </div>

    <div id="log-area">Nh·∫≠t k√Ω...</div>
    <canvas id="output"></canvas>
    <video id="webcam" playsinline autoplay muted></video>

    <script>
        const logArea = document.getElementById('log-area');
        const statusEl = document.getElementById('status');
        const btnForce = document.querySelector('.btn-force');
        const btnCheck = document.querySelector('.btn-check');

        function log(msg, type='') {
            const color = type === 'err' ? 'log-err' : (type === 'ok' ? 'log-success' : '');
            logArea.innerHTML += `<div class="${color}">[${new Date().toLocaleTimeString()}] ${msg}</div>`;
            logArea.scrollTop = logArea.scrollHeight;
        }

        // B·∫Øt l·ªói Promise (L·ªói WASM th∆∞·ªùng ·∫©n ·ªü ƒë√¢y)
        window.addEventListener('unhandledrejection', function(event) {
            log("‚ùå L·ªñI NG·∫¶M (Promise Rejection): " + event.reason, 'err');
        });
        
        // B·∫Øt l·ªói Javascript chung
        window.onerror = function(message, source, lineno, colno, error) {
            log(`‚ùå L·ªñI JS: ${message} (D√≤ng ${lineno})`, 'err');
        };
    </script>

    <script>
        var Module = {
            onRuntimeInitialized: function() {
                log("‚úÖ ƒê·ªòNG C∆† ƒê√É N·ªî! (WASM Runtime Init)", 'ok');
                statusEl.innerText = "AI ƒê√£ T·∫£i Xong!";
                statusEl.style.color = "#00ff00";
                startCameraLogic();
            },
            locateFile: function(path) {
                log(`üîç T√¨m file: ${path} -> D√πng: edge-impulse-standalone.wasm`);
                return "edge-impulse-standalone.wasm";
            }
        };
    </script>

    <script>
        function runSystem() {
            btnCheck.disabled = true;
            log("--- B·∫ÆT ƒê·∫¶U N·∫†P FILE ---");
            
            // N·∫°p file JS ch√≠nh
            const script = document.createElement('script');
            script.src = "edge-impulse-standalone.js";
            script.onload = () => {
                log("‚úÖ ƒê√£ t·∫£i xong file JS. ƒêang ch·ªù WASM...", 'ok');
                // N·∫øu sau 3 gi√¢y m√† ch∆∞a th·∫•y g√¨ -> Hi·ªán n√∫t k√≠ch n·ªï
                setTimeout(() => {
                    if (!window.isWasmRunning) {
                        log("‚ö†Ô∏è C·∫£nh b√°o: WASM ch∆∞a ch·∫°y t·ª± ƒë·ªông. H√£y th·ª≠ k√≠ch n·ªï.", 'warn');
                        btnForce.style.display = 'inline-block';
                        statusEl.innerText = "C·∫ßn k√≠ch ho·∫°t th·ªß c√¥ng";
                    }
                }, 3000);
            };
            document.body.appendChild(script);

            // N·∫°p file run-impulse
            const script2 = document.createElement('script');
            script2.src = "run-impulse.js";
            document.body.appendChild(script2);
        }

        // H√ÄM K√çCH N·ªî (G·ªçi th·ªß c√¥ng Factory Function)
        function forceStart() {
            log("‚ö° ƒêANG K√çCH N·ªî TH·ª¶ C√îNG...", 'warn');
            
            // Ki·ªÉm tra c√°c t√™n h√†m th∆∞·ªùng g·∫∑p
            let factory = null;
            if (typeof createModule === 'function') factory = createModule;
            else if (typeof EdgeImpulseMod === 'function') factory = EdgeImpulseMod;
            else if (typeof Module === 'function') factory = Module;

            if (factory) {
                log(`‚úÖ T√¨m th·∫•y h√†m kh·ªüi ƒë·ªông: ${factory.name}. ƒêang g·ªçi...`, 'ok');
                factory(Module).then(() => {
                    log("‚úÖ K√≠ch n·ªï th√†nh c√¥ng! WASM ƒëang ch·∫°y.", 'ok');
                }).catch(e => {
                    log("‚ùå K√≠ch n·ªï th·∫•t b·∫°i: " + e.message, 'err');
                });
            } else {
                log("‚ùå Kh√¥ng t√¨m th·∫•y h√†m kh·ªüi ƒë·ªông n√†o (createModule/EdgeImpulseMod).", 'err');
                // Th·ª≠ ki·ªÉm tra module.exports
                if (typeof module !== 'undefined' && module.exports) {
                     log("Ph√°t hi·ªán module.exports...", 'warn');
                     if (typeof module.exports === 'function') {
                         module.exports(Module);
                     } else if (typeof module.exports.createModule === 'function') {
                         module.exports.createModule(Module);
                     }
                }
            }
        }
    </script>

    <script>
        const video = document.getElementById('webcam');
        const canvas = document.getElementById('output');
        const ctx = canvas.getContext('2d');
        var classifier = null;

        async function startCameraLogic() {
            window.isWasmRunning = true;
            btnForce.style.display = 'none';
            log("üì∑ ƒêang b·∫≠t Camera...", 'ok');

            try {
                if (typeof EdgeImpulseClassifier === 'undefined') {
                    throw new Error("Ch∆∞a t·∫£i run-impulse.js");
                }

                classifier = new EdgeImpulseClassifier();
                await classifier.init();
                
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: false,
                    video: { facingMode: "environment", width: 640, height: 480 }
                });
                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    video.play();
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    log("üé• CAMERA HO·∫†T ƒê·ªòNG!", 'ok');
                    requestAnimationFrame(loop);
                };
            } catch (e) {
                log("‚ùå L·ªói Camera: " + e.message, 'err');
            }
        }

        async function loop() {
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            if (classifier) {
                try {
                    let res = classifier.classifyElements(video);
                    if (res && res.results) {
                        res.results.forEach(obj => {
                            if (obj.x !== undefined) {
                                ctx.strokeStyle = '#00FF00'; ctx.lineWidth = 4;
                                ctx.strokeRect(obj.x, obj.y, obj.width, obj.height);
                                ctx.fillStyle = '#00FF00'; ctx.font = '20px Arial';
                                ctx.fillText(obj.label, obj.x, obj.y - 5);
                            } else if (obj.value > 0.5) {
                                ctx.fillStyle = "yellow"; ctx.font = "20px Arial";
                                ctx.fillText(`${obj.label}: ${(obj.value*100).toFixed(0)}%`, 20, 40);
                            }
                        });
                    }
                } catch (e) {}
            }
            requestAnimationFrame(loop);
        }
    </script>
</body>
</html>
