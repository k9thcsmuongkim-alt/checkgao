<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Camera Fixed Final</title>
    <style>
        body { background: #000; color: #fff; font-family: monospace; display: flex; flex-direction: column; align-items: center; margin: 0; padding: 10px; }
        
        #status-panel { width: 100%; max-width: 640px; background: #222; padding: 15px; border-bottom: 2px solid #555; text-align: center; }
        .status-text { font-size: 18px; font-weight: bold; margin-bottom: 10px; display: block; }
        .highlight { color: #00ff00; }
        .err { color: #ff5555; }
        
        #container { position: relative; width: 100%; max-width: 640px; margin-top: 10px; }
        canvas { width: 100%; height: auto; border: 2px solid #333; display: block; }
        video { display: none; }
        
        /* N√∫t b·∫Øt bu·ªôc (ch·ªâ hi·ªán khi c·∫ßn) */
        #btn-start { display: none; padding: 15px 30px; font-size: 18px; background: #2196F3; color: white; border: none; border-radius: 5px; cursor: pointer; margin-top: 10px; }
        
        /* Debug info */
        #debug-info { font-size: 12px; color: #aaa; margin-top: 5px; }
    </style>
</head>
<body>

    <div id="status-panel">
        <span id="status-text" class="status-text">ƒêang kh·ªüi t·∫°o h·ªá th·ªëng...</span>
        <div id="debug-info">Ch·ªù th∆∞ vi·ªán t·∫£i...</div>
        <button id="btn-start" onclick="initAI()">B·∫§M ƒê·ªÇ B·∫ÆT ƒê·∫¶U</button>
    </div>
    
    <div id="container">
        <canvas id="output"></canvas>
    </div>
    
    <canvas id="hidden-canvas" style="display:none;"></canvas>
    <video id="webcam" playsinline autoplay muted></video>

    <script>
        var Module = {
            locateFile: function(path) {
                // Ch·ªâ ƒë∆∞·ªùng cho file WASM
                return "edge-impulse-standalone.wasm";
            }
        };
    </script>

    <script src="edge-impulse-standalone.js"></script>
    <script src="run-impulse.js"></script>

    <script>
        const statusEl = document.getElementById('status-text');
        const debugEl = document.getElementById('debug-info');
        const btnStart = document.getElementById('btn-start');
        
        const video = document.getElementById('webcam');
        const canvas = document.getElementById('output');
        const ctx = canvas.getContext('2d');
        const hiddenCanvas = document.getElementById('hidden-canvas');
        const hiddenCtx = hiddenCanvas.getContext('2d');

        var classifier = null;
        var modelWidth = 96;
        var modelHeight = 96;
        var isCameraRunning = false;

        // T·ª± ƒë·ªông ch·∫°y khi trang t·∫£i xong
        window.onload = function() {
            // ƒê·ª£i 1 ch√∫t ƒë·ªÉ ƒë·∫£m b·∫£o file JS ƒë√£ n·∫°p
            setTimeout(initAI, 1000);
        };

        async function initAI() {
            btnStart.style.display = 'none';
            statusEl.innerText = "‚è≥ ƒêang n·∫°p Model AI...";
            
            try {
                if (typeof EdgeImpulseClassifier === 'undefined') {
                    throw new Error("Ch∆∞a t·∫£i ƒë∆∞·ª£c file run-impulse.js");
                }

                // Kh·ªüi t·∫°o Classifier (ƒê√¢y l√† b∆∞·ªõc quan tr·ªçng nh·∫•t)
                classifier = new EdgeImpulseClassifier();
                await classifier.init();
                
                statusEl.innerText = "‚úÖ AI ƒê√£ T·∫£i Xong! ƒêang ƒë·ªçc th√¥ng s·ªë...";
                statusEl.className = "status-text highlight";

                // --- T·ª∞ ƒê·ªòNG ƒê·ªåC K√çCH TH∆Ø·ªöC MODEL ---
                try {
                    let props = Module.get_properties();
                    debugEl.innerText = `Model Props: ${JSON.stringify(props)}`;
                    
                    if (props.image_input_width && props.image_input_height) {
                        modelWidth = props.image_input_width;
                        modelHeight = props.image_input_height;
                    }
                } catch (e) {
                    debugEl.innerText = "Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c props, d√πng m·∫∑c ƒë·ªãnh 96x96";
                }

                debugEl.innerText += ` | Input: ${modelWidth}x${modelHeight}`;
                
                // C√†i ƒë·∫∑t canvas ·∫©n
                hiddenCanvas.width = modelWidth;
                hiddenCanvas.height = modelHeight;

                // B·∫≠t Camera
                startCamera();

            } catch (err) {
                statusEl.innerText = "‚ùå L·ªói: " + err.message;
                statusEl.className = "status-text err";
                btnStart.style.display = 'inline-block'; // Hi·ªán n√∫t ƒë·ªÉ th·ª≠ l·∫°i
            }
        }

        async function startCamera() {
            statusEl.innerText = "üì∑ ƒêang m·ªü Camera...";
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: false,
                    video: { facingMode: "environment", width: 640, height: 480 }
                });
                
                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    video.play();
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    
                    isCameraRunning = true;
                    statusEl.innerText = "üü¢ ƒêang ho·∫°t ƒë·ªông";
                    requestAnimationFrame(loop);
                };
            } catch (err) {
                statusEl.innerText = "L·ªói Camera: " + err.message;
                statusEl.className = "status-text err";
            }
        }

        async function loop() {
            if (!isCameraRunning) return;

            // 1. V·∫Ω video l√™n m√†n h√¨nh
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            if (classifier) {
                try {
                    // 2. C·∫Øt ·∫£nh nh·ªè ƒë·ªÉ g·ª≠i cho AI
                    hiddenCtx.drawImage(video, 0, 0, modelWidth, modelHeight);
                    
                    // 3. L·∫•y d·ªØ li·ªáu pixel
                    let imageData = hiddenCtx.getImageData(0, 0, modelWidth, modelHeight);
                    let pixels = imageData.data;
                    
                    // 4. Chuy·ªÉn ƒë·ªïi sang Hex (Y√™u c·∫ßu c·ªßa Edge Impulse)
                    let features = [];
                    for (let i = 0; i < pixels.length; i += 4) {
                        let hex = (pixels[i] << 16) | (pixels[i + 1] << 8) | pixels[i + 2];
                        features.push(hex);
                    }

                    // 5. Ph√¢n lo·∫°i
                    let res = classifier.classify(features);

                    // 6. V·∫Ω k·∫øt qu·∫£
                    if (res && res.results && res.results.length > 0) {
                        res.results.forEach(obj => {
                            // V·∫Ω khung (Object Detection)
                            if (obj.x !== undefined) {
                                let scaleX = canvas.width / modelWidth;
                                let scaleY = canvas.height / modelHeight;
                                
                                let x = obj.x * scaleX;
                                let y = obj.y * scaleY;
                                let w = obj.width * scaleX;
                                let h = obj.height * scaleY;

                                ctx.strokeStyle = '#00FF00'; ctx.lineWidth = 4;
                                ctx.strokeRect(x, y, w, h);
                                ctx.fillStyle = '#00FF00'; ctx.font = '20px Arial';
                                ctx.fillText(`${obj.label} ${(obj.value*100).toFixed(0)}%`, x, y - 5);
                            } 
                            // Ph√¢n lo·∫°i ·∫£nh (Classification)
                            else if (obj.value > 0.5) {
                                ctx.fillStyle = "yellow"; ctx.font = "24px Arial";
                                ctx.fillText(`${obj.label}: ${(obj.value*100).toFixed(0)}%`, 20, 50);
                            }
                        });
                    }

                } catch (e) {
                    // B·ªè qua l·ªói frame drop
                }
            }
            requestAnimationFrame(loop);
        }
    </script>
</body>
</html>
